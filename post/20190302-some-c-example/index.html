<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style data-href="/styles.491a16106869c73de5f8.css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.21.13"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=91beeefb9e415739fef62dcc10c4d546"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=91beeefb9e415739fef62dcc10c4d546"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=91beeefb9e415739fef62dcc10c4d546"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=91beeefb9e415739fef62dcc10c4d546"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=91beeefb9e415739fef62dcc10c4d546"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=91beeefb9e415739fef62dcc10c4d546"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=91beeefb9e415739fef62dcc10c4d546"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=91beeefb9e415739fef62dcc10c4d546"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=91beeefb9e415739fef62dcc10c4d546"/><title data-react-helmet="true">c语言一些示例 | lqqyt2423&#x27;s blog</title><meta data-react-helmet="true" name="description" content="打开或关闭文件 读和写文件 sizet --- unsigned long
ssizet --- long RIO Robust I/O RIO 的无缓冲的输入输出函数 RIO 的带缓冲的输入函数        IP 地址 Unix 提供了下面这样的函数在网络和主机字节顺序间实现转换。 套接字地址结构 socket…"/><meta data-react-helmet="true" property="og:title" content="c语言一些示例"/><meta data-react-helmet="true" property="og:description" content="打开或关闭文件 读和写文件 sizet --- unsigned long
ssizet --- long RIO Robust I/O RIO 的无缓冲的输入输出函数 RIO 的带缓冲的输入函数        IP 地址 Unix 提供了下面这样的函数在网络和主机字节顺序间实现转换。 套接字地址结构 socket…"/><meta data-react-helmet="true" property="og:type" content="website"/><link as="script" rel="preload" href="/webpack-runtime-0df63275f2c0d3fbc9da.js"/><link as="script" rel="preload" href="/framework-5dd3c501fd049989ea3a.js"/><link as="script" rel="preload" href="/styles-37d63a57eaf6d055b3bc.js"/><link as="script" rel="preload" href="/app-3db1551ace671f07a932.js"/><link as="script" rel="preload" href="/commons-a3a9788009a5fa07c105.js"/><link as="script" rel="preload" href="/453e4dc8321690ed32f5449d9e741446843fbcaf-fa351f3bfeff8a8d4399.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-e617e17216a668ed3111.js"/><link as="fetch" rel="preload" href="/page-data/post/20190302-some-c-example/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;color:inherit" href="/">lqqyt2423&#x27;s blog</a></h3></header><main><article><header><h1 style="margin-top:1.75rem;margin-bottom:0">c语言一些示例</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem">March 01, 2019</p></header><section><p><code class="language-text">/1-导言/1.6.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 1-6</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> c<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d - at EOF\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/1.7.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 1-7</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"EOF is %d\n"</span><span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/a.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 打印华氏温度和摄氏温度对照表</span>
<span class="token comment">// c = (5/9) * (f-32)</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> fahr<span class="token punctuation">,</span> celsius<span class="token punctuation">;</span>
  <span class="token keyword">int</span> lower<span class="token punctuation">,</span> upper<span class="token punctuation">,</span> step<span class="token punctuation">;</span>

  lower <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  upper <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
  step <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

  fahr <span class="token operator">=</span> lower<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>fahr <span class="token operator">&lt;=</span> upper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    celsius <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr<span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t%d\n"</span><span class="token punctuation">,</span> fahr<span class="token punctuation">,</span> celsius<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fahr <span class="token operator">=</span> fahr <span class="token operator">+</span> step<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/b.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 打印华氏温度和摄氏温度对照表</span>
<span class="token comment">// c = (5/9) * (f-32)</span>
<span class="token comment">// 优化版本</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// 浮点数</span>
  <span class="token keyword">float</span> fahr<span class="token punctuation">,</span> celsius<span class="token punctuation">;</span>
  <span class="token keyword">int</span> lower<span class="token punctuation">,</span> upper<span class="token punctuation">,</span> step<span class="token punctuation">;</span>

  lower <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  upper <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
  step <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

  fahr <span class="token operator">=</span> lower<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>fahr <span class="token operator">&lt;=</span> upper<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    celsius <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">5.0</span><span class="token operator">/</span><span class="token number">9.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr<span class="token operator">-</span><span class="token number">32.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 输出美观</span>
    <span class="token comment">// %3.0f 至少占3字符宽，不带小数点和小数部分</span>
    <span class="token comment">// %6.1f 至少占6字符宽，小数点后面有1位数字</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%3.0f %6.1f\n"</span><span class="token punctuation">,</span> fahr<span class="token punctuation">,</span> celsius<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fahr <span class="token operator">=</span> fahr <span class="token operator">+</span> step<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/c.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"># <span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 摄氏温度转华氏温度</span>
<span class="token comment">// f = 9*c / 5 + 32</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">float</span> fahr<span class="token punctuation">,</span> celsius<span class="token punctuation">;</span>
  <span class="token keyword">int</span> lower<span class="token punctuation">,</span> upper<span class="token punctuation">,</span> step<span class="token punctuation">;</span>

  lower <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  upper <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
  step <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Celsius  Fahr\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  celsius <span class="token operator">=</span> lower<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>celsius <span class="token operator">&lt;=</span> upper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fahr <span class="token operator">=</span> <span class="token number">9.0</span> <span class="token operator">*</span> celsius <span class="token operator">/</span> <span class="token number">5.0</span> <span class="token operator">+</span> <span class="token number">32.0</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%3.0f     %6.1f\n"</span><span class="token punctuation">,</span> celsius<span class="token punctuation">,</span> fahr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    celsius <span class="token operator">=</span> celsius <span class="token operator">+</span> step<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/copy.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> c<span class="token punctuation">;</span>
  c <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    c <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/copy2.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> c<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/d.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 打印华氏温度和摄氏温度对照表</span>
<span class="token comment">// c = (5/9) * (f-32)</span>
<span class="token comment">// 优化版本</span>
<span class="token comment">// for</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">float</span> fahr<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>fahr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> fahr <span class="token operator">&lt;=</span> <span class="token number">300</span><span class="token punctuation">;</span> fahr <span class="token operator">=</span> fahr <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%3.0f %6.1f\n"</span><span class="token punctuation">,</span> fahr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5.0</span> <span class="token operator">/</span> <span class="token number">9.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr <span class="token operator">-</span> <span class="token number">32.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/e.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 打印华氏温度和摄氏温度对照表</span>
<span class="token comment">// c = (5/9) * (f-32)</span>
<span class="token comment">// 优化版本</span>
<span class="token comment">// for</span>
<span class="token comment">// 逆序</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">float</span> fahr<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>fahr <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span> fahr <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> fahr <span class="token operator">=</span> fahr <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%3.0f %6.1f\n"</span><span class="token punctuation">,</span> fahr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5.0</span> <span class="token operator">/</span> <span class="token number">9.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr <span class="token operator">-</span> <span class="token number">32.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/f.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> LOWER 0</span>
<span class="token macro property">#<span class="token directive keyword">define</span> UPPER 300</span>
<span class="token macro property">#<span class="token directive keyword">define</span> STEP 20</span>

<span class="token comment">// 打印华氏温度和摄氏温度对照表</span>
<span class="token comment">// c = (5/9) * (f-32)</span>
<span class="token comment">// 优化版本</span>
<span class="token comment">// for</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">float</span> fahr<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>fahr <span class="token operator">=</span> LOWER<span class="token punctuation">;</span> fahr <span class="token operator">&lt;=</span> UPPER<span class="token punctuation">;</span> fahr <span class="token operator">=</span> fahr <span class="token operator">+</span> STEP<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%3.0f %6.1f\n"</span><span class="token punctuation">,</span> fahr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5.0</span> <span class="token operator">/</span> <span class="token number">9.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr <span class="token operator">-</span> <span class="token number">32.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/hello.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello, world\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/10/cpstdin.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token comment">// 使用 read 和 write 调用一次一个字节地从标准输入复制到标准输出</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> c<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/10/csapp.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> RIO_BUFSIZE 8192</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> rio_fd<span class="token punctuation">;</span> <span class="token comment">// Descriptor for this internal buf</span>
  <span class="token keyword">int</span> rio_cnt<span class="token punctuation">;</span> <span class="token comment">// Unread bytes in internal buf</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>rio_bufptr<span class="token punctuation">;</span> <span class="token comment">// Next unread byte in internal buf</span>
  <span class="token keyword">char</span> rio_buf<span class="token punctuation">[</span>RIO_BUFSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Internal buffer</span>
<span class="token punctuation">}</span> rio_t<span class="token punctuation">;</span>

ssize_t <span class="token function">rio_readn</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Interrupted by sig handler return and call read() again</span>
      <span class="token comment">// 被应用信号处理程序的返回终端，手动重启</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// errno set by read()</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// EOF</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return >= 0</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_writen</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nwritten<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nwritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nwritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nwritten<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">rio_readinitb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rp<span class="token operator">-></span>rio_fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内部的 rio_read 函数</span>
<span class="token keyword">static</span> ssize_t <span class="token function">rio_read</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> cnt<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Refill if buf is empty</span>
    rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_fd<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// EOF</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span> <span class="token comment">// Reset buffer ptr</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Copy min(n, rp->rio_cnt) bytes from internal buf to user buf</span>
  cnt <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> n<span class="token punctuation">)</span>
    cnt <span class="token operator">=</span> rp<span class="token operator">-></span>rio_cnt<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>usrbuf<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_bufptr<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">+=</span> cnt<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">-=</span> cnt<span class="token punctuation">;</span>
  <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readlineb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t maxlen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> n<span class="token punctuation">,</span> rc<span class="token punctuation">;</span>
  <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> maxlen<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>bufp<span class="token operator">++</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        n<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// EOF, no data read</span>
      <span class="token keyword">else</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// EOF, some data was read</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Error</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span>bufp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readnb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/10/readme.md</code></p>
<p>打开或关闭文件</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> mode_t mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为新文件描述符，若出错为 -1</span></code></pre></div>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为 0，若出错则为 -1</span></code></pre></div>
<p>读和写文件</p>
<p>size<em>t --- unsigned long
ssize</em>t --- long</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

ssize_t <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为读的字节数，若 EOF 则为 0，若出错为 -1</span>

ssize_t <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为写的字节数，若出错则为 -1</span></code></pre></div>
<p>RIO Robust I/O</p>
<p>RIO 的无缓冲的输入输出函数</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">ssize_t <span class="token function">rio_readn</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">rio_writen</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为传送的字节数，若 EOF 则为 0，若出错则为 -1</span></code></pre></div>
<p>RIO 的带缓冲的输入函数</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">rio_readinitb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

ssize_t <span class="token function">rio_readlineb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t maxlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">rio_readnb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为读的字节数，若 EOF 则为 0，若出错则为 -1</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/csapp.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> RIO_BUFSIZE 8192</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> rio_fd<span class="token punctuation">;</span> <span class="token comment">// Descriptor for this internal buf</span>
  <span class="token keyword">int</span> rio_cnt<span class="token punctuation">;</span> <span class="token comment">// Unread bytes in internal buf</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>rio_bufptr<span class="token punctuation">;</span> <span class="token comment">// Next unread byte in internal buf</span>
  <span class="token keyword">char</span> rio_buf<span class="token punctuation">[</span>RIO_BUFSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Internal buffer</span>
<span class="token punctuation">}</span> rio_t<span class="token punctuation">;</span>

ssize_t <span class="token function">rio_readn</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Interrupted by sig handler return and call read() again</span>
      <span class="token comment">// 被应用信号处理程序的返回终端，手动重启</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// errno set by read()</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// EOF</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return >= 0</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_writen</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nwritten<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nwritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nwritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nwritten<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">rio_readinitb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rp<span class="token operator">-></span>rio_fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内部的 rio_read 函数</span>
<span class="token keyword">static</span> ssize_t <span class="token function">rio_read</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> cnt<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Refill if buf is empty</span>
    rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_fd<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// EOF</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span> <span class="token comment">// Reset buffer ptr</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Copy min(n, rp->rio_cnt) bytes from internal buf to user buf</span>
  cnt <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> n<span class="token punctuation">)</span>
    cnt <span class="token operator">=</span> rp<span class="token operator">-></span>rio_cnt<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>usrbuf<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_bufptr<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">+=</span> cnt<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">-=</span> cnt<span class="token punctuation">;</span>
  <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readlineb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t maxlen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> n<span class="token punctuation">,</span> rc<span class="token punctuation">;</span>
  <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> maxlen<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>bufp<span class="token operator">++</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        n<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// EOF, no data read</span>
      <span class="token keyword">else</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// EOF, some data was read</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Error</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span>bufp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readnb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 11</span>

<span class="token keyword">int</span> <span class="token function">open_clientfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> clientfd<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>listp<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

  <span class="token comment">// get a list of potential server addresses</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// open a connection</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_NUMERICSERV<span class="token punctuation">;</span> <span class="token comment">// using a numeric port arg</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">|=</span> AI_ADDRCONFIG<span class="token punctuation">;</span> <span class="token comment">// recommender for connections</span>
  <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// walk the list for one that we can successfully connect to</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> listp<span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// create a socket descriptor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>clientfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-></span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_socktype<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// socket failed, try the next</span>

    <span class="token comment">// connect to the server</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// success</span>

    <span class="token function">close</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// connect failed, try another</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// clean up</span>
  <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token comment">// all connects failed</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token comment">// the last connect succeeded</span>
    <span class="token keyword">return</span> clientfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">open_listenfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>listp<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
  <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> optval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// get a list of potential server addresses</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// accept connection</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE <span class="token operator">|</span> AI_ADDRCONFIG<span class="token punctuation">;</span> <span class="token comment">// on any IP address</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">|=</span> AI_NUMERICSERV<span class="token punctuation">;</span> <span class="token comment">// using port number</span>
  <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// walk the list for one that we can bind to</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> listp <span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// create a socket descriptor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-></span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_socktype<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// socket failed, try the next</span>

    <span class="token comment">// eliminates "address already in use" error from bind</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>optval<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// bind the descriptor to the address</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// success</span>

    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bind failed, try the next</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// clean up</span>
  <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token comment">// no address worked</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// make it a listening socket ready to accept connection requests</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> LISTENQ<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> listenfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/csapp.h</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> RIO_BUFSIZE 8192</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAXLINE 100</span>
<span class="token macro property">#<span class="token directive keyword">define</span> LISTENQ 1024</span>

<span class="token comment">// Unix-style error</span>
<span class="token keyword">void</span> <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s: %s\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

pid_t <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pid_t pid<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"Fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> rio_fd<span class="token punctuation">;</span> <span class="token comment">// Descriptor for this internal buf</span>
  <span class="token keyword">int</span> rio_cnt<span class="token punctuation">;</span> <span class="token comment">// Unread bytes in internal buf</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>rio_bufptr<span class="token punctuation">;</span> <span class="token comment">// Next unread byte in internal buf</span>
  <span class="token keyword">char</span> rio_buf<span class="token punctuation">[</span>RIO_BUFSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Internal buffer</span>
<span class="token punctuation">}</span> rio_t<span class="token punctuation">;</span>

ssize_t <span class="token function">rio_readn</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Interrupted by sig handler return and call read() again</span>
      <span class="token comment">// 被应用信号处理程序的返回终端，手动重启</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// errno set by read()</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// EOF</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return >= 0</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_writen</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nwritten<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nwritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nwritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nwritten<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">rio_readinitb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rp<span class="token operator">-></span>rio_fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内部的 rio_read 函数</span>
<span class="token keyword">static</span> ssize_t <span class="token function">rio_read</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> cnt<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Refill if buf is empty</span>
    rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_fd<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// EOF</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span> <span class="token comment">// Reset buffer ptr</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Copy min(n, rp->rio_cnt) bytes from internal buf to user buf</span>
  cnt <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> n<span class="token punctuation">)</span>
    cnt <span class="token operator">=</span> rp<span class="token operator">-></span>rio_cnt<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>usrbuf<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_bufptr<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">+=</span> cnt<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">-=</span> cnt<span class="token punctuation">;</span>
  <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readlineb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t maxlen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> n<span class="token punctuation">,</span> rc<span class="token punctuation">;</span>
  <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> maxlen<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>bufp<span class="token operator">++</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        n<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// EOF, no data read</span>
      <span class="token keyword">else</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// EOF, some data was read</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Error</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span>bufp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readnb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 11</span>

<span class="token keyword">int</span> <span class="token function">open_clientfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> clientfd<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>listp<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

  <span class="token comment">// get a list of potential server addresses</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// open a connection</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_NUMERICSERV<span class="token punctuation">;</span> <span class="token comment">// using a numeric port arg</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">|=</span> AI_ADDRCONFIG<span class="token punctuation">;</span> <span class="token comment">// recommender for connections</span>
  <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// walk the list for one that we can successfully connect to</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> listp<span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// create a socket descriptor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>clientfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-></span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_socktype<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// socket failed, try the next</span>

    <span class="token comment">// connect to the server</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// success</span>

    <span class="token function">close</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// connect failed, try another</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// clean up</span>
  <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token comment">// all connects failed</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token comment">// the last connect succeeded</span>
    <span class="token keyword">return</span> clientfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">open_listenfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>listp<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
  <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> optval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// get a list of potential server addresses</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// accept connection</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE <span class="token operator">|</span> AI_ADDRCONFIG<span class="token punctuation">;</span> <span class="token comment">// on any IP address</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">|=</span> AI_NUMERICSERV<span class="token punctuation">;</span> <span class="token comment">// using port number</span>
  <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// walk the list for one that we can bind to</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> listp <span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// create a socket descriptor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-></span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_socktype<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// socket failed, try the next</span>

    <span class="token comment">// eliminates "address already in use" error from bind</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>optval<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// bind the descriptor to the address</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// success</span>

    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bind failed, try the next</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// clean up</span>
  <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token comment">// no address worked</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// make it a listening socket ready to accept connection requests</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> LISTENQ<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> listenfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t n<span class="token punctuation">;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  rio_t rio<span class="token punctuation">;</span>

  <span class="token function">rio_readinitb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">rio_readlineb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server received %d bytes\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rio_writen</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/echo.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token keyword">void</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t n<span class="token punctuation">;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  rio_t rio<span class="token punctuation">;</span>

  <span class="token function">rio_readinitb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">rio_readlineb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server received %d bytes\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rio_writen</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/echoclient.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> clientfd<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token operator">*</span>port<span class="token punctuation">,</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  rio_t rio<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"usage: %s &lt;host> &lt;port>\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  host <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  port <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  clientfd <span class="token operator">=</span> <span class="token function">open_clientfd</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">rio_readinitb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> clientfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">rio_writen</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rio_readlineb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">close</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/echoserveri.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token keyword">void</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> connfd<span class="token punctuation">;</span>
  socklen_t clientlen<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> clientaddr<span class="token punctuation">;</span> <span class="token comment">// enough space for any address</span>
  <span class="token keyword">char</span> client_hostname<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">,</span> client_port<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"usage: %s &lt;port>\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  listenfd <span class="token operator">=</span> <span class="token function">open_listenfd</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clientlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>clientaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getnameinfo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>clientaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> clientlen<span class="token punctuation">,</span> client_hostname<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">,</span> client_port<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Connected to (%s %s)\n"</span><span class="token punctuation">,</span> client_hostname<span class="token punctuation">,</span> client_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">echo</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/hostinfo.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token operator">*</span>listp<span class="token punctuation">,</span> hints<span class="token punctuation">;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> rc<span class="token punctuation">,</span> flags<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"usage: %s &lt;domain name>\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// get a list of addrinfo records</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span> <span class="token comment">// IPv4 only</span>
  hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// Connections only</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>listp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"getaddrinfo error: %s\n"</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Walk the list and display each IP address</span>
  flags <span class="token operator">=</span> NI_NUMERICHOST<span class="token punctuation">;</span> <span class="token comment">// Display address string instead of domain name</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> listp<span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">getnameinfo</span><span class="token punctuation">(</span>p<span class="token operator">-></span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addrlen<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Clean up</span>
  <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/readme.md</code></p>
<p>IP 地址</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// IP address structure</span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">{</span>
  uint32_t s_addr<span class="token punctuation">;</span> <span class="token comment">// Address in netword byte order (big-endian)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Unix 提供了下面这样的函数在网络和主机字节顺序间实现转换。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>

uint32_t <span class="token function">htonl</span><span class="token punctuation">(</span>uint32_t hostlong<span class="token punctuation">)</span><span class="token punctuation">;</span>
uint16_t <span class="token function">htons</span><span class="token punctuation">(</span>uint16_t hostshort<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：按照网络字节顺序的值</span>

uint32_t <span class="token function">ntohl</span><span class="token punctuation">(</span>uint32_t netlong<span class="token punctuation">)</span><span class="token punctuation">;</span>
uint16_t <span class="token function">ntohs</span><span class="token punctuation">(</span>uint16_t netshort<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：按照主机字节顺序的值</span></code></pre></div>
<p>套接字地址结构</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// IP socket address structure</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token punctuation">{</span>
  uint16_t sin_family<span class="token punctuation">;</span>
  uint16_t sin_port<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Generic socket address structure</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token punctuation">{</span>
  uint16_t sa_family<span class="token punctuation">;</span>
  <span class="token keyword">char</span> sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>socket 函数</p>
<p>客户端和服务器使用 socket 函数来创建一个套接字描述符。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为非负描述符，若出错则为 -1</span></code></pre></div>
<p>connect 函数</p>
<p>客户端通过调用 connect 函数来建立和服务器的连接。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> clientfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为 0，若出错则为 -1</span></code></pre></div>
<p>connect 函数会阻塞</p>
<p>服务器：bind、listen 和 accept</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为 0，若出错则为 -1</span></code></pre></div>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为 0，若出错则为 -1</span></code></pre></div>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为非负连接描述符，若出错则为 -1</span></code></pre></div>
<p>getaddrinfo 函数</p>
<p>将主机名、主机地址、服务名和端口号的字符串表示转化成套接字地址结构。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>

<span class="token keyword">int</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>hints<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span><span class="token operator">*</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：如果成功则为 0，如果错误则为非零的错误代码</span>

<span class="token keyword">void</span> <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回： 无</span>

<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">gai_strerror</span><span class="token punctuation">(</span><span class="token keyword">int</span> errcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：错误消息</span></code></pre></div>
<p>addrinfo 结构</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> ai_flags<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ai_family<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ai_socktype<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ai_protocol<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>ai_canonname<span class="token punctuation">;</span>
  size_t ai_addrlen<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>ai_addr<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>ai_next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>getnameinfo 与 getaddrinfo 相反</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>

<span class="token keyword">int</span> <span class="token function">getnameinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sa<span class="token punctuation">,</span> socklen_t salen<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> size_t hostlen<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> service<span class="token punctuation">,</span> size_t servlen<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：如果成功则为 0，如果错误则为非零的错误代码</span></code></pre></div>
<p>套接字接口辅助函数</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open_clientfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">open_listenfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为描述符，若出错则为 -1</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/7-link/main.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/7-link/readme.md</code></p>
<p>gcc -Og -o prog main.c sum.c</p>
<hr>
<p><code class="language-text">/deep/7-link/sum.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">,</span> s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">+=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/csapp.h</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>

<span class="token comment">// Unix-style error</span>
<span class="token keyword">void</span> <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s: %s\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

pid_t <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pid_t pid<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"Fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/fork.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  pid_t pid<span class="token punctuation">;</span>
  <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 子进程</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child : x=%d\n"</span><span class="token punctuation">,</span> <span class="token operator">++</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 父进程</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent: x=%d\n"</span><span class="token punctuation">,</span> <span class="token operator">--</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/get_pid.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当前进程</span>
  pid_t p <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid: %d\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 父进程</span>
  p <span class="token operator">=</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ppid: %d\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 进程组</span>
  p <span class="token operator">=</span> <span class="token function">getpgrp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pgrp: %d\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/hello.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"hello, world\n"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/kill.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pid_t pid<span class="token punctuation">;</span>

  <span class="token comment">// Child sleeps until SIGKILL signal received, then dies</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Wait for a signal to arrive</span>
    <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"control should never reach here!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Parent sends a SIGKILL signal to a child</span>
  <span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/sigint.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token comment">// 捕获键盘 Ctrl+C 发送的 SIGINT 信号</span>

<span class="token comment">// SIGINT handler</span>
<span class="token keyword">void</span> <span class="token function">sigint_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Caught SIGINT!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Install the SIGINT handler</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> sigint_handler<span class="token punctuation">)</span> <span class="token operator">==</span> SIG_ERR<span class="token punctuation">)</span>
    <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"signal error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Wait for the receipt of a signal</span>
  <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/waitpid1.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> N 10</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> status<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
  pid_t pid<span class="token punctuation">;</span>

  <span class="token comment">// 创建 N 个子进程</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 子进程退出</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 回收子进程，顺序不固定</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d terminated normally with exit status=%d\n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d terminated abnormally\n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 最后一次调用 waitpid 返回 -1，并设置 errno 为 ECHILD</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> ECHILD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"waitpid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/waitpid2.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> N 10</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> status<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
  pid_t pid<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> retpid<span class="token punctuation">;</span>

  <span class="token comment">// 创建 N 个子进程</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 子进程退出</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 回收子进程，顺序固定</span>
  i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>retpid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d terminated normally with exit status=%d\n"</span><span class="token punctuation">,</span> retpid<span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d terminated abnormally\n"</span><span class="token punctuation">,</span> retpid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 最后一次调用 waitpid 返回 -1，并设置 errno 为 ECHILD</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> ECHILD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"waitpid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/note.md</code></p>
<h1>C程序设计语言</h1>
<h2>1 - 导言</h2>
<p>编译：cc hello.c</p>
<p>执行：./a.out</p>
<p><code class="language-text">include &lt;stdio.h&gt;</code> 包含标准库的信息，告诉编译器在本程序中包含标准输入/输出库的信息。</p>
<p>程序的起点为 main 函数</p>
<p>main 函数不接收参数值</p>
<p>用双引号括起来的字符序列称为<strong>字符串</strong>或<strong>字符常量</strong>。</p>
<p>printf 函数不是C语言本身的一部分，仅是标准库函数中的一个函数。</p>
<ul>
<li>%3.0f 至少占3字符宽，不带小数点和小数部分</li>
<li>%6.1f 至少占6字符宽，小数点后面有1位数字</li>
<li>%d 十进制</li>
<li>%f 浮点数</li>
<li>%o 八进制</li>
<li>%x 十六进制</li>
<li>%c 字符</li>
<li>%s 字符串</li>
<li>%% %</li>
</ul>
<p><code class="language-text">#define</code> 指令可以把符号名（符号变量）定义为一个特定的字符串：<code class="language-text">#define 名字 替换文本</code>，指令末尾无分号。</p>
<p>getchar() 和 putchar()</p>
<ul>
<li>getchar 从文本流中读入下一个输入字符，作为结果返回</li>
<li>putchar 将打印一个字符</li>
</ul>
<p>EOF end of file 定义在头文件<code class="language-text">&lt;stdio.h&gt;</code> 中，是一个<strong>整型数</strong>。与任何 char 类型的值都不相同。</p>
<hr>
<p><code class="language-text">/tmp/main.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">multstore</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">long</span> d<span class="token punctuation">;</span>
  <span class="token function">multstore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2 * 3 --> %ld\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">long</span> <span class="token function">mult2</span><span class="token punctuation">(</span><span class="token keyword">long</span> a<span class="token punctuation">,</span> <span class="token keyword">long</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">long</span> s <span class="token operator">=</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/tmp/mstore.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">mult2</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">multstore</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> y<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token operator">*</span>dest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">long</span> t <span class="token operator">=</span> <span class="token function">mult2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>dest <span class="token operator">=</span> t<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/tmp/show_bytes.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 使用强制类型转换来访问和打印不同程序对象的字节表示</span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>byte_pointer<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">show_bytes</span><span class="token punctuation">(</span>byte_pointer start<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 因为 char 类型的指针每次是按照字节加 1</span>
  <span class="token comment">// 所以可以打印出存储在相应地址的字节</span>

  <span class="token comment">// pa[i] 与 *(pa+i) 是等价的</span>
  <span class="token comment">// 一个通过数组和下标实现的表达式可等价地通过指针和偏移量实现</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 数组形式</span>
    <span class="token comment">// start[i] 表示读取以 start 指向的位置为起始的第 i 个位置处的字节</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" %.2x"</span><span class="token punctuation">,</span> start<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 指针形式</span>
    <span class="token comment">// printf(" %.2x", *start++);</span>
  <span class="token punctuation">}</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">show_int</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 强制类型转换</span>
  <span class="token comment">// 并不会改变真实的指针，而是告诉编译器以新的数据类型来看待被指向的数据</span>
  <span class="token function">show_bytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte_pointer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">show_float</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">show_bytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte_pointer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 指向任何对象的指针都可以转换为 void * 类型，且不会丢失信息</span>
<span class="token comment">// 如果将结果再转换为初始指针类型，则可以恢复初始指针</span>
<span class="token comment">// ANSI C 使用类型 void * 代替 char * 作为通用指针的类型</span>
<span class="token keyword">void</span> <span class="token function">show_pointer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">show_bytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte_pointer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">test_show_bytes</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> ival <span class="token operator">=</span> val<span class="token punctuation">;</span>
  <span class="token comment">// 39 30 00 00 => 小端法</span>
  <span class="token function">show_int</span><span class="token punctuation">(</span>ival<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">show_float</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>ival<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">show_pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ival<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 0x00003039</span>
  <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">12345</span><span class="token punctuation">;</span>
  <span class="token function">test_show_bytes</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">show_bytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte_pointer<span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token string">"12345"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/tmp.md</code></p>
<p><code class="language-text">/1-导言/1.6.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 1-6</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> c<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d - at EOF\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/1.7.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 1-7</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"EOF is %d\n"</span><span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/a.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 打印华氏温度和摄氏温度对照表</span>
<span class="token comment">// c = (5/9) * (f-32)</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> fahr<span class="token punctuation">,</span> celsius<span class="token punctuation">;</span>
  <span class="token keyword">int</span> lower<span class="token punctuation">,</span> upper<span class="token punctuation">,</span> step<span class="token punctuation">;</span>

  lower <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  upper <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
  step <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

  fahr <span class="token operator">=</span> lower<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>fahr <span class="token operator">&lt;=</span> upper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    celsius <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr<span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t%d\n"</span><span class="token punctuation">,</span> fahr<span class="token punctuation">,</span> celsius<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fahr <span class="token operator">=</span> fahr <span class="token operator">+</span> step<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/b.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 打印华氏温度和摄氏温度对照表</span>
<span class="token comment">// c = (5/9) * (f-32)</span>
<span class="token comment">// 优化版本</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// 浮点数</span>
  <span class="token keyword">float</span> fahr<span class="token punctuation">,</span> celsius<span class="token punctuation">;</span>
  <span class="token keyword">int</span> lower<span class="token punctuation">,</span> upper<span class="token punctuation">,</span> step<span class="token punctuation">;</span>

  lower <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  upper <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
  step <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

  fahr <span class="token operator">=</span> lower<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>fahr <span class="token operator">&lt;=</span> upper<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    celsius <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">5.0</span><span class="token operator">/</span><span class="token number">9.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr<span class="token operator">-</span><span class="token number">32.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 输出美观</span>
    <span class="token comment">// %3.0f 至少占3字符宽，不带小数点和小数部分</span>
    <span class="token comment">// %6.1f 至少占6字符宽，小数点后面有1位数字</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%3.0f %6.1f\n"</span><span class="token punctuation">,</span> fahr<span class="token punctuation">,</span> celsius<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fahr <span class="token operator">=</span> fahr <span class="token operator">+</span> step<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/c.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"># <span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 摄氏温度转华氏温度</span>
<span class="token comment">// f = 9*c / 5 + 32</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">float</span> fahr<span class="token punctuation">,</span> celsius<span class="token punctuation">;</span>
  <span class="token keyword">int</span> lower<span class="token punctuation">,</span> upper<span class="token punctuation">,</span> step<span class="token punctuation">;</span>

  lower <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  upper <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
  step <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Celsius  Fahr\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  celsius <span class="token operator">=</span> lower<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>celsius <span class="token operator">&lt;=</span> upper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fahr <span class="token operator">=</span> <span class="token number">9.0</span> <span class="token operator">*</span> celsius <span class="token operator">/</span> <span class="token number">5.0</span> <span class="token operator">+</span> <span class="token number">32.0</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%3.0f     %6.1f\n"</span><span class="token punctuation">,</span> celsius<span class="token punctuation">,</span> fahr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    celsius <span class="token operator">=</span> celsius <span class="token operator">+</span> step<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/copy.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> c<span class="token punctuation">;</span>
  c <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    c <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/copy2.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> c<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/d.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 打印华氏温度和摄氏温度对照表</span>
<span class="token comment">// c = (5/9) * (f-32)</span>
<span class="token comment">// 优化版本</span>
<span class="token comment">// for</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">float</span> fahr<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>fahr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> fahr <span class="token operator">&lt;=</span> <span class="token number">300</span><span class="token punctuation">;</span> fahr <span class="token operator">=</span> fahr <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%3.0f %6.1f\n"</span><span class="token punctuation">,</span> fahr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5.0</span> <span class="token operator">/</span> <span class="token number">9.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr <span class="token operator">-</span> <span class="token number">32.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/e.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 打印华氏温度和摄氏温度对照表</span>
<span class="token comment">// c = (5/9) * (f-32)</span>
<span class="token comment">// 优化版本</span>
<span class="token comment">// for</span>
<span class="token comment">// 逆序</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">float</span> fahr<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>fahr <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span> fahr <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> fahr <span class="token operator">=</span> fahr <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%3.0f %6.1f\n"</span><span class="token punctuation">,</span> fahr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5.0</span> <span class="token operator">/</span> <span class="token number">9.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr <span class="token operator">-</span> <span class="token number">32.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/f.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> LOWER 0</span>
<span class="token macro property">#<span class="token directive keyword">define</span> UPPER 300</span>
<span class="token macro property">#<span class="token directive keyword">define</span> STEP 20</span>

<span class="token comment">// 打印华氏温度和摄氏温度对照表</span>
<span class="token comment">// c = (5/9) * (f-32)</span>
<span class="token comment">// 优化版本</span>
<span class="token comment">// for</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">float</span> fahr<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>fahr <span class="token operator">=</span> LOWER<span class="token punctuation">;</span> fahr <span class="token operator">&lt;=</span> UPPER<span class="token punctuation">;</span> fahr <span class="token operator">=</span> fahr <span class="token operator">+</span> STEP<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%3.0f %6.1f\n"</span><span class="token punctuation">,</span> fahr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5.0</span> <span class="token operator">/</span> <span class="token number">9.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr <span class="token operator">-</span> <span class="token number">32.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/1-导言/hello.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello, world\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/10/cpstdin.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token comment">// 使用 read 和 write 调用一次一个字节地从标准输入复制到标准输出</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> c<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/10/csapp.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> RIO_BUFSIZE 8192</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> rio_fd<span class="token punctuation">;</span> <span class="token comment">// Descriptor for this internal buf</span>
  <span class="token keyword">int</span> rio_cnt<span class="token punctuation">;</span> <span class="token comment">// Unread bytes in internal buf</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>rio_bufptr<span class="token punctuation">;</span> <span class="token comment">// Next unread byte in internal buf</span>
  <span class="token keyword">char</span> rio_buf<span class="token punctuation">[</span>RIO_BUFSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Internal buffer</span>
<span class="token punctuation">}</span> rio_t<span class="token punctuation">;</span>

ssize_t <span class="token function">rio_readn</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Interrupted by sig handler return and call read() again</span>
      <span class="token comment">// 被应用信号处理程序的返回终端，手动重启</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// errno set by read()</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// EOF</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return >= 0</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_writen</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nwritten<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nwritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nwritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nwritten<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">rio_readinitb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rp<span class="token operator">-></span>rio_fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内部的 rio_read 函数</span>
<span class="token keyword">static</span> ssize_t <span class="token function">rio_read</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> cnt<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Refill if buf is empty</span>
    rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_fd<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// EOF</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span> <span class="token comment">// Reset buffer ptr</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Copy min(n, rp->rio_cnt) bytes from internal buf to user buf</span>
  cnt <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> n<span class="token punctuation">)</span>
    cnt <span class="token operator">=</span> rp<span class="token operator">-></span>rio_cnt<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>usrbuf<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_bufptr<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">+=</span> cnt<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">-=</span> cnt<span class="token punctuation">;</span>
  <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readlineb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t maxlen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> n<span class="token punctuation">,</span> rc<span class="token punctuation">;</span>
  <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> maxlen<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>bufp<span class="token operator">++</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        n<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// EOF, no data read</span>
      <span class="token keyword">else</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// EOF, some data was read</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Error</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span>bufp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readnb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/10/readme.md</code></p>
<p>打开或关闭文件</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> mode_t mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为新文件描述符，若出错为 -1</span></code></pre></div>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为 0，若出错则为 -1</span></code></pre></div>
<p>读和写文件</p>
<p>size<em>t --- unsigned long
ssize</em>t --- long</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

ssize_t <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为读的字节数，若 EOF 则为 0，若出错为 -1</span>

ssize_t <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为写的字节数，若出错则为 -1</span></code></pre></div>
<p>RIO Robust I/O</p>
<p>RIO 的无缓冲的输入输出函数</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">ssize_t <span class="token function">rio_readn</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">rio_writen</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为传送的字节数，若 EOF 则为 0，若出错则为 -1</span></code></pre></div>
<p>RIO 的带缓冲的输入函数</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">rio_readinitb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

ssize_t <span class="token function">rio_readlineb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t maxlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">rio_readnb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为读的字节数，若 EOF 则为 0，若出错则为 -1</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/csapp.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> RIO_BUFSIZE 8192</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> rio_fd<span class="token punctuation">;</span> <span class="token comment">// Descriptor for this internal buf</span>
  <span class="token keyword">int</span> rio_cnt<span class="token punctuation">;</span> <span class="token comment">// Unread bytes in internal buf</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>rio_bufptr<span class="token punctuation">;</span> <span class="token comment">// Next unread byte in internal buf</span>
  <span class="token keyword">char</span> rio_buf<span class="token punctuation">[</span>RIO_BUFSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Internal buffer</span>
<span class="token punctuation">}</span> rio_t<span class="token punctuation">;</span>

ssize_t <span class="token function">rio_readn</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Interrupted by sig handler return and call read() again</span>
      <span class="token comment">// 被应用信号处理程序的返回终端，手动重启</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// errno set by read()</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// EOF</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return >= 0</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_writen</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nwritten<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nwritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nwritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nwritten<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">rio_readinitb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rp<span class="token operator">-></span>rio_fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内部的 rio_read 函数</span>
<span class="token keyword">static</span> ssize_t <span class="token function">rio_read</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> cnt<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Refill if buf is empty</span>
    rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_fd<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// EOF</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span> <span class="token comment">// Reset buffer ptr</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Copy min(n, rp->rio_cnt) bytes from internal buf to user buf</span>
  cnt <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> n<span class="token punctuation">)</span>
    cnt <span class="token operator">=</span> rp<span class="token operator">-></span>rio_cnt<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>usrbuf<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_bufptr<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">+=</span> cnt<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">-=</span> cnt<span class="token punctuation">;</span>
  <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readlineb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t maxlen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> n<span class="token punctuation">,</span> rc<span class="token punctuation">;</span>
  <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> maxlen<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>bufp<span class="token operator">++</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        n<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// EOF, no data read</span>
      <span class="token keyword">else</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// EOF, some data was read</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Error</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span>bufp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readnb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 11</span>

<span class="token keyword">int</span> <span class="token function">open_clientfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> clientfd<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>listp<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

  <span class="token comment">// get a list of potential server addresses</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// open a connection</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_NUMERICSERV<span class="token punctuation">;</span> <span class="token comment">// using a numeric port arg</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">|=</span> AI_ADDRCONFIG<span class="token punctuation">;</span> <span class="token comment">// recommender for connections</span>
  <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// walk the list for one that we can successfully connect to</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> listp<span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// create a socket descriptor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>clientfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-></span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_socktype<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// socket failed, try the next</span>

    <span class="token comment">// connect to the server</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// success</span>

    <span class="token function">close</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// connect failed, try another</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// clean up</span>
  <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token comment">// all connects failed</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token comment">// the last connect succeeded</span>
    <span class="token keyword">return</span> clientfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">open_listenfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>listp<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
  <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> optval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// get a list of potential server addresses</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// accept connection</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE <span class="token operator">|</span> AI_ADDRCONFIG<span class="token punctuation">;</span> <span class="token comment">// on any IP address</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">|=</span> AI_NUMERICSERV<span class="token punctuation">;</span> <span class="token comment">// using port number</span>
  <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// walk the list for one that we can bind to</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> listp <span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// create a socket descriptor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-></span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_socktype<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// socket failed, try the next</span>

    <span class="token comment">// eliminates "address already in use" error from bind</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>optval<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// bind the descriptor to the address</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// success</span>

    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bind failed, try the next</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// clean up</span>
  <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token comment">// no address worked</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// make it a listening socket ready to accept connection requests</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> LISTENQ<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> listenfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/csapp.h</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> RIO_BUFSIZE 8192</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAXLINE 100</span>
<span class="token macro property">#<span class="token directive keyword">define</span> LISTENQ 1024</span>

<span class="token comment">// Unix-style error</span>
<span class="token keyword">void</span> <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s: %s\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

pid_t <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pid_t pid<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"Fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> rio_fd<span class="token punctuation">;</span> <span class="token comment">// Descriptor for this internal buf</span>
  <span class="token keyword">int</span> rio_cnt<span class="token punctuation">;</span> <span class="token comment">// Unread bytes in internal buf</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>rio_bufptr<span class="token punctuation">;</span> <span class="token comment">// Next unread byte in internal buf</span>
  <span class="token keyword">char</span> rio_buf<span class="token punctuation">[</span>RIO_BUFSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Internal buffer</span>
<span class="token punctuation">}</span> rio_t<span class="token punctuation">;</span>

ssize_t <span class="token function">rio_readn</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Interrupted by sig handler return and call read() again</span>
      <span class="token comment">// 被应用信号处理程序的返回终端，手动重启</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// errno set by read()</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// EOF</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return >= 0</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_writen</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nwritten<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nwritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nwritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    nleft <span class="token operator">-=</span> nwritten<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">rio_readinitb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rp<span class="token operator">-></span>rio_fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内部的 rio_read 函数</span>
<span class="token keyword">static</span> ssize_t <span class="token function">rio_read</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> cnt<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Refill if buf is empty</span>
    rp<span class="token operator">-></span>rio_cnt <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_fd<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// EOF</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        rp<span class="token operator">-></span>rio_bufptr <span class="token operator">=</span> rp<span class="token operator">-></span>rio_buf<span class="token punctuation">;</span> <span class="token comment">// Reset buffer ptr</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Copy min(n, rp->rio_cnt) bytes from internal buf to user buf</span>
  cnt <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rp<span class="token operator">-></span>rio_cnt <span class="token operator">&lt;</span> n<span class="token punctuation">)</span>
    cnt <span class="token operator">=</span> rp<span class="token operator">-></span>rio_cnt<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>usrbuf<span class="token punctuation">,</span> rp<span class="token operator">-></span>rio_bufptr<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_bufptr <span class="token operator">+=</span> cnt<span class="token punctuation">;</span>
  rp<span class="token operator">-></span>rio_cnt <span class="token operator">-=</span> cnt<span class="token punctuation">;</span>
  <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readlineb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t maxlen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> n<span class="token punctuation">,</span> rc<span class="token punctuation">;</span>
  <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> maxlen<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>bufp<span class="token operator">++</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        n<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// EOF, no data read</span>
      <span class="token keyword">else</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// EOF, some data was read</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Error</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span>bufp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token function">rio_readnb</span><span class="token punctuation">(</span>rio_t <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> size_t n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
  ssize_t nread<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>bufp <span class="token operator">=</span> usrbuf<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">rio_read</span><span class="token punctuation">(</span>rp<span class="token punctuation">,</span> bufp<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
    bufp <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nleft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 11</span>

<span class="token keyword">int</span> <span class="token function">open_clientfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> clientfd<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>listp<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

  <span class="token comment">// get a list of potential server addresses</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// open a connection</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_NUMERICSERV<span class="token punctuation">;</span> <span class="token comment">// using a numeric port arg</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">|=</span> AI_ADDRCONFIG<span class="token punctuation">;</span> <span class="token comment">// recommender for connections</span>
  <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// walk the list for one that we can successfully connect to</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> listp<span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// create a socket descriptor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>clientfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-></span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_socktype<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// socket failed, try the next</span>

    <span class="token comment">// connect to the server</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// success</span>

    <span class="token function">close</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// connect failed, try another</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// clean up</span>
  <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token comment">// all connects failed</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token comment">// the last connect succeeded</span>
    <span class="token keyword">return</span> clientfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">open_listenfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>listp<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
  <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> optval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// get a list of potential server addresses</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// accept connection</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE <span class="token operator">|</span> AI_ADDRCONFIG<span class="token punctuation">;</span> <span class="token comment">// on any IP address</span>
  hints<span class="token punctuation">.</span>ai_flags <span class="token operator">|=</span> AI_NUMERICSERV<span class="token punctuation">;</span> <span class="token comment">// using port number</span>
  <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// walk the list for one that we can bind to</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> listp <span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// create a socket descriptor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-></span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_socktype<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// socket failed, try the next</span>

    <span class="token comment">// eliminates "address already in use" error from bind</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>optval<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// bind the descriptor to the address</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// success</span>

    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bind failed, try the next</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// clean up</span>
  <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token comment">// no address worked</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// make it a listening socket ready to accept connection requests</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> LISTENQ<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> listenfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t n<span class="token punctuation">;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  rio_t rio<span class="token punctuation">;</span>

  <span class="token function">rio_readinitb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">rio_readlineb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server received %d bytes\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rio_writen</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/echo.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token keyword">void</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t n<span class="token punctuation">;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  rio_t rio<span class="token punctuation">;</span>

  <span class="token function">rio_readinitb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">rio_readlineb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server received %d bytes\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rio_writen</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/echoclient.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> clientfd<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token operator">*</span>port<span class="token punctuation">,</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  rio_t rio<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"usage: %s &lt;host> &lt;port>\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  host <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  port <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  clientfd <span class="token operator">=</span> <span class="token function">open_clientfd</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">rio_readinitb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> clientfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">rio_writen</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rio_readlineb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rio<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">close</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/echoserveri.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token keyword">void</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> connfd<span class="token punctuation">;</span>
  socklen_t clientlen<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> clientaddr<span class="token punctuation">;</span> <span class="token comment">// enough space for any address</span>
  <span class="token keyword">char</span> client_hostname<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">,</span> client_port<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"usage: %s &lt;port>\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  listenfd <span class="token operator">=</span> <span class="token function">open_listenfd</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clientlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>clientaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getnameinfo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>clientaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> clientlen<span class="token punctuation">,</span> client_hostname<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">,</span> client_port<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Connected to (%s %s)\n"</span><span class="token punctuation">,</span> client_hostname<span class="token punctuation">,</span> client_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">echo</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/hostinfo.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token operator">*</span>listp<span class="token punctuation">,</span> hints<span class="token punctuation">;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> rc<span class="token punctuation">,</span> flags<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"usage: %s &lt;domain name>\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// get a list of addrinfo records</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span> <span class="token comment">// IPv4 only</span>
  hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// Connections only</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>listp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"getaddrinfo error: %s\n"</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Walk the list and display each IP address</span>
  flags <span class="token operator">=</span> NI_NUMERICHOST<span class="token punctuation">;</span> <span class="token comment">// Display address string instead of domain name</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> listp<span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">getnameinfo</span><span class="token punctuation">(</span>p<span class="token operator">-></span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-></span>ai_addrlen<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Clean up</span>
  <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/11/readme.md</code></p>
<p>IP 地址</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// IP address structure</span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">{</span>
  uint32_t s_addr<span class="token punctuation">;</span> <span class="token comment">// Address in netword byte order (big-endian)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Unix 提供了下面这样的函数在网络和主机字节顺序间实现转换。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>

uint32_t <span class="token function">htonl</span><span class="token punctuation">(</span>uint32_t hostlong<span class="token punctuation">)</span><span class="token punctuation">;</span>
uint16_t <span class="token function">htons</span><span class="token punctuation">(</span>uint16_t hostshort<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：按照网络字节顺序的值</span>

uint32_t <span class="token function">ntohl</span><span class="token punctuation">(</span>uint32_t netlong<span class="token punctuation">)</span><span class="token punctuation">;</span>
uint16_t <span class="token function">ntohs</span><span class="token punctuation">(</span>uint16_t netshort<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：按照主机字节顺序的值</span></code></pre></div>
<p>套接字地址结构</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// IP socket address structure</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token punctuation">{</span>
  uint16_t sin_family<span class="token punctuation">;</span>
  uint16_t sin_port<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Generic socket address structure</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token punctuation">{</span>
  uint16_t sa_family<span class="token punctuation">;</span>
  <span class="token keyword">char</span> sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>socket 函数</p>
<p>客户端和服务器使用 socket 函数来创建一个套接字描述符。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为非负描述符，若出错则为 -1</span></code></pre></div>
<p>connect 函数</p>
<p>客户端通过调用 connect 函数来建立和服务器的连接。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> clientfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为 0，若出错则为 -1</span></code></pre></div>
<p>connect 函数会阻塞</p>
<p>服务器：bind、listen 和 accept</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为 0，若出错则为 -1</span></code></pre></div>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为 0，若出错则为 -1</span></code></pre></div>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为非负连接描述符，若出错则为 -1</span></code></pre></div>
<p>getaddrinfo 函数</p>
<p>将主机名、主机地址、服务名和端口号的字符串表示转化成套接字地址结构。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>

<span class="token keyword">int</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>hints<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span><span class="token operator">*</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：如果成功则为 0，如果错误则为非零的错误代码</span>

<span class="token keyword">void</span> <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回： 无</span>

<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">gai_strerror</span><span class="token punctuation">(</span><span class="token keyword">int</span> errcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：错误消息</span></code></pre></div>
<p>addrinfo 结构</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> ai_flags<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ai_family<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ai_socktype<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ai_protocol<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>ai_canonname<span class="token punctuation">;</span>
  size_t ai_addrlen<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>ai_addr<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>ai_next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>getnameinfo 与 getaddrinfo 相反</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>

<span class="token keyword">int</span> <span class="token function">getnameinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sa<span class="token punctuation">,</span> socklen_t salen<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> size_t hostlen<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> service<span class="token punctuation">,</span> size_t servlen<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：如果成功则为 0，如果错误则为非零的错误代码</span></code></pre></div>
<p>套接字接口辅助函数</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open_clientfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">open_listenfd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回：若成功则为描述符，若出错则为 -1</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/7-link/main.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/7-link/readme.md</code></p>
<p>gcc -Og -o prog main.c sum.c</p>
<hr>
<p><code class="language-text">/deep/7-link/sum.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">,</span> s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">+=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/csapp.h</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>

<span class="token comment">// Unix-style error</span>
<span class="token keyword">void</span> <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s: %s\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

pid_t <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pid_t pid<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"Fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/fork.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  pid_t pid<span class="token punctuation">;</span>
  <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 子进程</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child : x=%d\n"</span><span class="token punctuation">,</span> <span class="token operator">++</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 父进程</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent: x=%d\n"</span><span class="token punctuation">,</span> <span class="token operator">--</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/get_pid.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当前进程</span>
  pid_t p <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid: %d\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 父进程</span>
  p <span class="token operator">=</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ppid: %d\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 进程组</span>
  p <span class="token operator">=</span> <span class="token function">getpgrp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pgrp: %d\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/hello.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"hello, world\n"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/kill.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pid_t pid<span class="token punctuation">;</span>

  <span class="token comment">// Child sleeps until SIGKILL signal received, then dies</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Wait for a signal to arrive</span>
    <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"control should never reach here!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Parent sends a SIGKILL signal to a child</span>
  <span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/sigint.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>

<span class="token comment">// 捕获键盘 Ctrl+C 发送的 SIGINT 信号</span>

<span class="token comment">// SIGINT handler</span>
<span class="token keyword">void</span> <span class="token function">sigint_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Caught SIGINT!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Install the SIGINT handler</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> sigint_handler<span class="token punctuation">)</span> <span class="token operator">==</span> SIG_ERR<span class="token punctuation">)</span>
    <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"signal error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Wait for the receipt of a signal</span>
  <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/waitpid1.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> N 10</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> status<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
  pid_t pid<span class="token punctuation">;</span>

  <span class="token comment">// 创建 N 个子进程</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 子进程退出</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 回收子进程，顺序不固定</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d terminated normally with exit status=%d\n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d terminated abnormally\n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 最后一次调用 waitpid 返回 -1，并设置 errno 为 ECHILD</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> ECHILD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"waitpid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/deep/8/waitpid2.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"csapp.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> N 10</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> status<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
  pid_t pid<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> retpid<span class="token punctuation">;</span>

  <span class="token comment">// 创建 N 个子进程</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 子进程退出</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 回收子进程，顺序固定</span>
  i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>retpid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d terminated normally with exit status=%d\n"</span><span class="token punctuation">,</span> retpid<span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d terminated abnormally\n"</span><span class="token punctuation">,</span> retpid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 最后一次调用 waitpid 返回 -1，并设置 errno 为 ECHILD</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> ECHILD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"waitpid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/note.md</code></p>
<h1>C程序设计语言</h1>
<h2>1 - 导言</h2>
<p>编译：cc hello.c</p>
<p>执行：./a.out</p>
<p><code class="language-text">include &lt;stdio.h&gt;</code> 包含标准库的信息，告诉编译器在本程序中包含标准输入/输出库的信息。</p>
<p>程序的起点为 main 函数</p>
<p>main 函数不接收参数值</p>
<p>用双引号括起来的字符序列称为<strong>字符串</strong>或<strong>字符常量</strong>。</p>
<p>printf 函数不是C语言本身的一部分，仅是标准库函数中的一个函数。</p>
<ul>
<li>%3.0f 至少占3字符宽，不带小数点和小数部分</li>
<li>%6.1f 至少占6字符宽，小数点后面有1位数字</li>
<li>%d 十进制</li>
<li>%f 浮点数</li>
<li>%o 八进制</li>
<li>%x 十六进制</li>
<li>%c 字符</li>
<li>%s 字符串</li>
<li>%% %</li>
</ul>
<p><code class="language-text">#define</code> 指令可以把符号名（符号变量）定义为一个特定的字符串：<code class="language-text">#define 名字 替换文本</code>，指令末尾无分号。</p>
<p>getchar() 和 putchar()</p>
<ul>
<li>getchar 从文本流中读入下一个输入字符，作为结果返回</li>
<li>putchar 将打印一个字符</li>
</ul>
<p>EOF end of file 定义在头文件<code class="language-text">&lt;stdio.h&gt;</code> 中，是一个<strong>整型数</strong>。与任何 char 类型的值都不相同。</p>
<hr>
<p><code class="language-text">/tmp/main.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">multstore</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">long</span> d<span class="token punctuation">;</span>
  <span class="token function">multstore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2 * 3 --> %ld\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">long</span> <span class="token function">mult2</span><span class="token punctuation">(</span><span class="token keyword">long</span> a<span class="token punctuation">,</span> <span class="token keyword">long</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">long</span> s <span class="token operator">=</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/tmp/mstore.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">mult2</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">multstore</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> y<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token operator">*</span>dest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">long</span> t <span class="token operator">=</span> <span class="token function">mult2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>dest <span class="token operator">=</span> t<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<hr>
<p><code class="language-text">/tmp/show_bytes.c</code></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 使用强制类型转换来访问和打印不同程序对象的字节表示</span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>byte_pointer<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">show_bytes</span><span class="token punctuation">(</span>byte_pointer start<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 因为 char 类型的指针每次是按照字节加 1</span>
  <span class="token comment">// 所以可以打印出存储在相应地址的字节</span>

  <span class="token comment">// pa[i] 与 *(pa+i) 是等价的</span>
  <span class="token comment">// 一个通过数组和下标实现的表达式可等价地通过指针和偏移量实现</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 数组形式</span>
    <span class="token comment">// start[i] 表示读取以 start 指向的位置为起始的第 i 个位置处的字节</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" %.2x"</span><span class="token punctuation">,</span> start<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 指针形式</span>
    <span class="token comment">// printf(" %.2x", *start++);</span>
  <span class="token punctuation">}</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">show_int</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 强制类型转换</span>
  <span class="token comment">// 并不会改变真实的指针，而是告诉编译器以新的数据类型来看待被指向的数据</span>
  <span class="token function">show_bytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte_pointer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">show_float</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">show_bytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte_pointer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 指向任何对象的指针都可以转换为 void * 类型，且不会丢失信息</span>
<span class="token comment">// 如果将结果再转换为初始指针类型，则可以恢复初始指针</span>
<span class="token comment">// ANSI C 使用类型 void * 代替 char * 作为通用指针的类型</span>
<span class="token keyword">void</span> <span class="token function">show_pointer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">show_bytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte_pointer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">test_show_bytes</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> ival <span class="token operator">=</span> val<span class="token punctuation">;</span>
  <span class="token comment">// 39 30 00 00 => 小端法</span>
  <span class="token function">show_int</span><span class="token punctuation">(</span>ival<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">show_float</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>ival<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">show_pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ival<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 0x00003039</span>
  <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">12345</span><span class="token punctuation">;</span>
  <span class="token function">test_show_bytes</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">show_bytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte_pointer<span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token string">"12345"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div></section><hr style="margin-bottom:1.75rem"/><footer><div style="display:flex;margin-bottom:4.375rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAMEBQL/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgT/2gAMAwEAAhADEAAAAZ6GtBn00V8nGSXIM//EABwQAAICAgMAAAAAAAAAAAAAAAEDAhEAFBIxM//aAAgBAQABBQJ3nydZm+5CwehgbIo2Jg7LM//EABcRAQEBAQAAAAAAAAAAAAAAAAARARL/2gAIAQMBAT8BlctXX//EABgRAAIDAAAAAAAAAAAAAAAAAAABEBEx/9oACAECAQE/AcLFH//EAB0QAAEEAgMAAAAAAAAAAAAAAAABAhFBEDEhgZH/2gAIAQEABj8CU30cQRjQ59oUV4f/xAAcEAEAAgIDAQAAAAAAAAAAAAABABEhMUFRYXH/2gAIAQEAAT8hukbmD64QTMF9S1UV6QCQxqyVFUEHye8P/9oADAMBAAIAAwAAABAMP/3/xAAYEQEBAAMAAAAAAAAAAAAAAAAAATFhcf/aAAgBAwEBPxAdLsw3P//EABkRAQEAAwEAAAAAAAAAAAAAAAEAETFhcf/aAAgBAgEBPxA4vEB3YL//xAAcEAEAAwEBAAMAAAAAAAAAAAABABEhMbGB0eH/2gAIAQEAAT8QJyKTvKuAkEWjRQe8mUggzn3BIYyqdXW3UEqPnZgRsjM5L7Q5v2P5yf/Z" alt="lqqyt2423" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/static/b27a6947a93c31de08bd6427d5cdf25d/99438/profile-pic.jpg 1x,
/static/b27a6947a93c31de08bd6427d5cdf25d/aba1d/profile-pic.jpg 1.5x,
/static/b27a6947a93c31de08bd6427d5cdf25d/b315d/profile-pic.jpg 2x" /><img loading="lazy" width="50" height="50" srcset="/static/b27a6947a93c31de08bd6427d5cdf25d/99438/profile-pic.jpg 1x,
/static/b27a6947a93c31de08bd6427d5cdf25d/aba1d/profile-pic.jpg 1.5x,
/static/b27a6947a93c31de08bd6427d5cdf25d/b315d/profile-pic.jpg 2x" src="/static/b27a6947a93c31de08bd6427d5cdf25d/99438/profile-pic.jpg" alt="lqqyt2423" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p>Written by <strong>lqqyt2423</strong> <!-- -->who lives and works in Shanghai building useful things.<!-- --> <a href="https://github.com/lqqyt2423">You should follow him on Github</a></p></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/post/20190213-recent-notes/">← <!-- -->最近的笔记</a></li><li><a rel="next" href="/post/20190623-compare-node-go-java-web-perfermance/">对比node/go/java等语言web服务器性能<!-- --> →</a></li></ul></nav></main><footer>© <!-- -->2020<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/post/20190302-some-c-example/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-3db1551ace671f07a932.js"],"component---src-pages-404-js":["/component---src-pages-404-js-ed9b337638234d604390.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-887140cad17a72a4ce9a.js"],"component---src-templates-blog-page-tsx":["/component---src-templates-blog-page-tsx-6720eb6103de617dc81f.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-e617e17216a668ed3111.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-e617e17216a668ed3111.js" async=""></script><script src="/453e4dc8321690ed32f5449d9e741446843fbcaf-fa351f3bfeff8a8d4399.js" async=""></script><script src="/commons-a3a9788009a5fa07c105.js" async=""></script><script src="/app-3db1551ace671f07a932.js" async=""></script><script src="/styles-37d63a57eaf6d055b3bc.js" async=""></script><script src="/framework-5dd3c501fd049989ea3a.js" async=""></script><script src="/webpack-runtime-0df63275f2c0d3fbc9da.js" async=""></script></body></html>